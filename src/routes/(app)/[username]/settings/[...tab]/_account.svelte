<script>
  import { tick } from "svelte";
  import { avatar, banner } from "$lib/store";
  import Icon from "$comp/Icon.svelte";
  import { t } from "$lib/translations";
  import { page } from "$app/stores";

  export let user, rates, submit;

  let { id } = user;

  let avatarFile, avatarInput, bannerFile, bannerInput;

  let selectAvatar = () => avatarInput.click();
  let selectBanner = () => bannerInput.click();

  let percent;
  let progress = async (event) => {
    percent = Math.round((event.loaded / event.total) * 100);
  };

  let tooLarge = {};

  let handleFile = async ({ target }, type) => {
    tooLarge[type] = false;
    let file = target.files[0];
    if (!file) return;

    if (file.size > 10000000) return (tooLarge[type] = true);

    if (type === "profile") {
      $avatar = { id, file, type, progress };
    } else if (type === "banner") {
      $banner = { id, file, type, progress };
    }

    var reader = new FileReader();
    reader.onload = async (e) => {
      if (type === "profile") {
        $avatar.src = e.target.result;
      } else if (type === "banner") {
        $banner.src = e.target.result;
      }
    };

    reader.readAsDataURL(file);
  };

  if (!user.display) user.display = user.username;

  $: url = `${$page.url.host}/${user.username}`;
  $: full = `${$page.url.protocol}//${url}`;
  $: addr = `${user.username}@${$page.url.host}`;
</script>

<div>
  <label for="username" class="font-bold mb-3 block"
    >{$t("user.settings.username")}</label
  >
  <div class="flex mb-2">
    <input
      type="text"
      name="username"
      bind:value={user.username}
      class="w-auto min-w-0 pr-1 grow dark:bg-stone-800 dark:border-0"
    />
  </div>
</div>

<div>
  <label for="display" class="font-bold mb-3 block"
    >{$t("user.settings.displayName")}</label
  >
  <input type="text" name="display" bind:value={user.display} class="dark:bg-stone-800 dark:border-0" />
</div>

<div class="space-y-1 relative">
  <label for="email" class="font-bold block">{$t("user.settings.email")}</label>
  <p class="text-secondary dark:text-gray-200">
    {$t("user.settings.emailDescription")}
  </p>

  <div class="relative">
    <input type="text" name="email" bind:value={user.email} class="dark:bg-stone-800 dark:border-0" />
    {#if user.verified}
      <Icon icon="check" style="absolute right-5 top-3 w-8" />
    {:else if user.email}
      <Icon icon="orangeclock" style="absolute right-5 top-3 w-8" />
    {/if}
  </div>
</div>

<div>
  <span class="font-bold">{$t("user.settings.profileImage")}</span>

  <div class="flex">
    {#if $avatar || user.profile}
      <!-- svelte-ignore a11y-no-static-element-interactions -->
      <div
        class="relative rounded-full overflow-hidden text-center w-20 h-20 my-auto hover:opacity-80 cursor-pointer"
        on:click={selectAvatar}
        on:keydown={selectAvatar}
      >
        <img
          src={$avatar?.src || `/api/public/${user.profile}.webp`}
          class="absolute w-full h-full object-cover object-center visible overflow-hidden "
          alt={user.username}
        />
      </div>
    {:else}
      <!-- svelte-ignore a11y-no-static-element-interactions -->
      <div
        class="rounded-full border-4 border-white p-4 bg-gradient-to-r from-primary to-gradient w-24 my-auto hover:opacity-80 cursor-pointer"
        on:click={selectAvatar}
        on:keydown={selectAvatar}
      >
        <Icon icon="logo-symbol-white" style="mx-auto" />
      </div>
    {/if}
    <div class="ml-2 p-2">
      <!-- found missing translation -->
      <button
        type="button"
        class="border rounded-2xl font-bold w-24 text-center px-0 py-2 hover:opacity-80 dark:border-white"
        on:click={selectAvatar}
        on:keydown={selectAvatar}>{$t("user.settings.select")}</button
      >
      <input
        type="file"
        class="hidden"
        bind:this={avatarInput}
        on:change={(e) => handleFile(e, "profile")}
      />
    </div>
  </div>

  {#if tooLarge["avatar"]}
    <div class="text-red-600">Max file size 10MB</div>
  {/if}
</div>

<div>
  <div class="flex justify-between items-center mb-3">
    <span class="font-bold">{$t("user.settings.bannerImage")}</span>
  </div>

  {#if $banner || user.banner}
    <!-- svelte-ignore a11y-no-noninteractive-element-interactions -->
    <img
      src={$banner ? $banner.src : `/api/public/${user.banner}.webp`}
      class="w-full object-cover object-center visible overflow-hidden h-48 mb-4 hover:opacity-80"
      on:click={selectBanner}
      on:keydown={selectBanner}
      alt="Banner"
    />
  {:else}
    <!-- svelte-ignore a11y-no-static-element-interactions -->
    <div
      class="bg-gradient-to-r dark:!from-stone-800 dark:!to-stone-800 w-full h-48 mb-4 cursor-pointer hover:opacity-80"
      on:click={selectBanner}
      on:keydown={selectBanner}
      alt="Banner"
    />
  {/if}

  <button
    type="button"
    class="border dark:border-white rounded-2xl font-bold w-24 text-center px-0 py-2 hover:opacity-80 "
    on:click={selectBanner}
    on:keydown={selectBanner}>{$t("user.settings.select")}</button
  >
  <input
    type="file"
    class="hidden"
    bind:this={bannerInput}
    on:change={(e) => handleFile(e, "banner")}
  />

  {#if tooLarge["banner"]}
    <div class="text-red-600">Max file size 10MB</div>
  {/if}
</div>

<div>
  <label for="address" class="font-bold mb-3 block"
    >{$t("user.settings.about")}</label
  >
  <textarea
    type="text"
    name="address"
    bind:value={user.address}
    placeholder={$t("user.settings.aboutPlaceholder")}
    class="dark:bg-stone-800 dark:border-0 dark:placeholder:text-gray-300"
  />
</div>
